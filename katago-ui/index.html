<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>荳ｭ逶､髯仙ｮ壼峇遒・ｼ磯ｻ・縺ゅ↑縺・逋ｽ=AI・・/title>
<style>
  body{font-family:system-ui,sans-serif;margin:16px;padding-right:12px;box-sizing:border-box;}
  .hud{margin:8px 0;display:flex;flex-direction:column;gap:8px;}
  .hud-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
  .hud-row .eval{margin-right:8px;}
  button{padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
  #sprintBtn{background:#3f51b5;color:#fff;border:none} #sprintBtn:hover{background:#303f9f}
  #resetBtn{background:#8d6e63;color:#fff;border:none}   #resetBtn:hover{background:#6d4c41}
  .board-wrap{display:flex;justify-content:flex-start;width:100%}
  .board,.cell,.hud button{touch-action:manipulation;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
  .board{
  position:relative;
  display:grid;
  grid-template-columns:repeat(19,28px);
  grid-template-rows:repeat(19,28px);
  width:calc(19 * 28px);
  height:calc(19 * 28px);
  background:url("./board_19x19_3.png") no-repeat center/100% 100%;
  margin:0 auto;              /* 竊・荳ｭ螟ｮ蟇・○・壼ｷｦ蜿ｳ縺ｫ蝮・ｭ峨↑菴咏區縺後〒縺阪ｋ */
  float:none;
  }

/* 逶､縺ｮ蜿ｳ縺ｫ窶懈欠縺ｮ騾・￡蝣ｴ窶昴→騾乗・繝偵ャ繝医・繝・け繧ｹ繧堤畑諢・*/
.board-shelf{ position:relative; display:inline-block; }
.hitbox-right{
  position:absolute; top:0; right:0; width:0; height:100%;
  pointer-events:auto; background:transparent;
}

/* 繧ｹ繝槭・譎ゑｼ壼承繧ｬ繧ｿ繝ｼ繧貞ｸｸ縺ｫ遒ｺ菫昴＠縲√ヲ繝・ヨ繝懊ャ繧ｯ繧ｹ繧堤乢縺ｮ螟悶∈蠑ｵ繧雁・縺・*/
@media (max-width: 640px){
  .board-shelf{ padding-right:max(24px, env(safe-area-inset-right, 0px)); }
  .hitbox-right{ width:32px; transform:translateX(50%); } /* 逶､縺ｮ螟悶∈邏・6px蠑ｵ繧雁・縺・*/
}



/* 繧ｹ繝槭・縺ｧ縺ｮ蜿ｳ遶ｯ隱､繧ｿ繝・・繧帝亟縺舌◆繧√・窶懷ｮ牙・繝槭・繧ｸ繝ｳ窶・*/
@media (max-width: 640px) {
  html,body { overscroll-behavior-x: contain; } /* 蜿ｳ遶ｯ繧ｹ繝ｯ繧､繝玲綾繧狗ｭ峨ｒ謚大宛・・ndroid縺ｧ譛牙柑・・*/
  body { padding-left:12px; padding-right:max(24px, env(safe-area-inset-right)); }
}

  .board-wrap,.board{text-align:initial}
  .cell{width:28px;height:28px;background:transparent;position:relative;cursor:pointer}
  .stone{position:absolute;inset:0;border-radius:80%;background-position:center;background-size:135%;background-repeat:no-repeat;box-shadow:none;pointer-events:none}
  .black{background-image:url("./black.png")} .white{background-image:url("./white.png")}
  .lastmove::after{content:"";position:absolute;width:10px;height:10px;border:2px solid red;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none}
  .stone.ghost{pointer-events:none;width:35px;height:35px;opacity:.55;transform:translate(-50%,-50%);display:none;z-index:10;inset:auto}
  .eval{margin-top:8px;font-size:14px;color:#222}

.board.ended { opacity:.92; filter:grayscale(.1); }

/* 讌ｷ譖ｸ・域蕗遘第嶌菴鍋ｳｻ繧呈怙蜆ｪ蜈茨ｼ俄・遶ｯ譛ｫ縺ｫ縺ゅｌ縺ｰ閾ｪ蜍輔〒諡ｾ縺・*/
#title{
  font-family:
    /* JP: 貂ｸ謨咏ｧ第嶌菴難ｼ・OS/mac縺ｫ螟壹＞・・*/
    "YuKyokasho", "Yu Kyokasho", "YuKyokasho Pr6N", "Yu Kyokasho Pr6N",
    /* JP: HG邉ｻ・・indows迺ｰ蠅・〒蜈･縺｣縺ｦ縺・ｋ蝣ｴ蜷医≠繧奇ｼ・*/
    "HG謨咏ｧ第嶌菴・, "HG豁｣讌ｷ譖ｸ菴・PRO", "HGP豁｣讌ｷ譖ｸ菴・PRO",
    /* ZH: 讌ｷ菴難ｼ育ｫｯ譛ｫ縺ｫ繧医ｊ莉｣譖ｿ縺ｨ縺励※陦ｨ遉ｺ・・*/
    "STKaiti", "KaiTi", "DFKai-SB",
    /* Fallbacks */
    "Yu Mincho", "Hiragino Mincho ProN", "MS PMincho",
    serif;
  font-weight: 600;            /* 讌ｷ譖ｸ繧峨＠縺・さ繝ｳ繝医Λ繧ｹ繝・*/
  letter-spacing: .05em;       /* 縺ｻ繧薙・蟆代＠蟄鈴俣繧堤ｩｺ縺代※謨ｴ縺医ｋ */
  line-height: 1.15;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  font-feature-settings: "palt" 1, "kern" 1; /* 繝励Ο繝昴・繧ｷ繝ｧ繝翫Ν・・き繝ｼ繝九Φ繧ｰ */
  white-space: nowrap;         /* 謚倥ｊ縺溘￥縺ｪ縺・ｴ蜷医・菫晄戟 */
  margin: 0 0 8px;
}




</style>
</head>
<body>
  <h1 id="title"><b>荳ｭ逶､髯仙ｮ壼峇遒・/b></h1>

  <div class="hud">
    <div class="hud-row">
      <div class="eval" id="eval">谿九ｊ謇区焚: -</div>
      <div class="eval" id="evalFirst">鮟貞享邇・ ・域悴險育ｮ暦ｼ・/div>
    </div>


    <div class="hud-row">
      <button id="sprintBtn">荳ｭ逶､隱ｭ縺ｿ霎ｼ縺ｿ</button>
      <button id="resetBtn">逶､繧偵け繝ｪ繧｢</button>
      <label>蠑ｷ縺・
        <select id="difficulty">
          <option value="easy">蠑ｱ縺・/option>
          <option value="normal" selected>譎ｮ騾・/option>
          <option value="hard">蠑ｷ縺・/option>
        </select>
      </label>
      <span class="info" id="status">鮟堤分縺ｧ縺吶・/span>
    </div>
  </div>

<div class="board-shelf">
  <div id="board" class="board">
    <div id="ghost" class="stone ghost"></div>
  </div>
  <div id="hitboxRight" class="hitbox-right" aria-hidden="true"></div>
</div>

  <details class="rules">
    <summary>蛻､螳壹Ν繝ｼ繝ｫ</summary>
    <div class="rules-box">
      <ul style="margin:0; padding-left:1.1em;">
        <li>譌ｩ譛溽ｵゆｺ・ <strong>10謇倶ｻ･髯・/strong>縲・strong>2蝗樣｣邯・/strong>縺ｧ <span class="nowrap">轤ｹ蟾ｮ竕･10逶ｮ</span> 縺ｾ縺溘・ <span class="nowrap">蜍晉紫竕･70%/竕､30%</span> 縺ｫ縺ｪ縺｣縺溷・縺ｮ蜍昴■縲・/li>
        <li>貅莠・ 谿九ｊ謇区焚0縺ｧ縲√◎縺ｮ譎らせ縺ｮ <span class="nowrap">轤ｹ蟾ｮ or 蜍晉紫</span> 縺ｧ蜆ｪ蜍｢蛛ｴ縺ｮ蜍昴■縲・/li>
      </ul>
    </div>
  </details>

  <pre id="last" style="display:none;margin-top:12px;background:#fafafa;padding:8px;border:1px solid #eee;border-radius:8px;max-height:220px;overflow:auto;"></pre>

<script>
// --- Safe helpers for evalFirst (null-guard & auto-create) ---
function ensureEvalFirst(){
  let el = document.getElementById('evalFirst');
  if (el) return el;
  const parent = document.querySelector('.hud-row') || document.querySelector('.hud') || document.body;
  el = document.createElement('div');
  el.className = 'eval';
  el.id = 'evalFirst';
  el.textContent = '鮟貞享邇・ ・域悴險育ｮ暦ｼ・;
  parent.appendChild(el);
  return el;
}
function setEvalFirst(text){
  const el = ensureEvalFirst();
  el.textContent = text;
}
// --- end helpers ---

/* ====== 蝓ｺ譛ｬ迥ｶ諷・====== */
const DEBUG = false;
const N = 19, CELL = 28;
const letters = "ABCDEFGHJKLMNOPQRST".split("");

const boardEl   = document.getElementById('board');
const ghostEl   = document.getElementById('ghost');
const statusEl  = document.getElementById('status');
const lastEl    = document.getElementById('last');
const sprintBtn = document.getElementById('sprintBtn');
const resetBtn  = document.getElementById('resetBtn');
const evalFirstEl = document.getElementById('evalFirst') || ensureEvalFirst();

// 蜿ｳ遶ｯ繝偵ャ繝医・繝・け繧ｹ 竊・譛蜿ｳ蛻・18)縺ｨ縺励※蜃ｦ逅・
const hitboxRight = document.getElementById('hitboxRight');
hitboxRight.addEventListener('pointerdown', async (e) => {
  e.preventDefault();
  if (!yourTurn) return;

  const rect = boardEl.getBoundingClientRect();
  const relY = e.clientY - rect.top;
  const y = Math.floor(relY / CELL);
  const x = N - 1; // 譛蜿ｳ蛻・

  if (y < 0 || y >= N) return;

  // 譌｢蟄倥そ繝ｫ縺ｨ蜷後§遒ｺ螳壹ヵ繝ｭ繝ｼ
  if (ghost && ghost.x === x && ghost.y === y) {
    clearGhost();
    if (!place('B', x, y)) { statusEl.textContent = "縺昴％縺ｫ縺ｯ謇薙※縺ｾ縺帙ｓ縲・; return; }
    try { const humanMove = toCoord(x, y); window.AiMoveNLP?.reactToHumanMove?.(humanMove); } catch {}
    moves.push(["B", toCoord(x, y)]);
    endState.plies++; endState.movesLeft = getMovesLeft();
    draw(); updateStatusHud(null);
    yourTurn = false; statusEl.textContent = "AI諤晁・ｸｭ窶ｦ";
    await aiReply();
  } else {
    showGhost(x, y);
  }
}, { passive:false });


let board = Array.from({length:N},()=>Array(N).fill(0)); // 0=遨ｺ,1=鮟・2=逋ｽ
let moves = [];                 // [["B","K10"],["W","D16"],...]
let yourTurn = true;            // 鮟停・逋ｽ窶ｦ縺ｮ莠､莉｣
let blackBaseline = 0;          // 蛻晄悄螻髱｢隱ｭ縺ｿ霎ｼ縺ｿ逶ｴ蠕後・鮟呈焔謨ｰ
let moveLimit = 100;             // 竭 谿九ｊ謇区焚
let moveStart = 0;              // 谿九ｊ謇区焚縺ｮ襍ｷ轤ｹ
let firstEvalWinrate = null;    // 蛻晄焔譎ゅ・鮟貞享邇・ｼ・..1・・

let gameOver = false;

function setBoardInteractive(flag){
  gameOver = !flag;
  boardEl.classList.toggle('ended', !flag);
  boardEl.style.pointerEvents = flag ? 'auto' : 'none';
  const hb = document.getElementById('hitboxRight');
  if (hb) hb.style.pointerEvents = flag ? 'auto' : 'none';
}


/* ====== 邨ゆｺ・愛螳・竭｡)縺ｮ險ｭ螳・====== */
const END_RULE = {
  early: { scoreLeadAbs: 10.0, winrateEdge: 0.20, requireConsec: 2, minPlies: 10 },
  onDepleted: "advantage" // 竭 moveLimit蛻ｰ驕疲凾縺ｯ鮟貞享邇・〒豎ｺ螳・
};
const endState = { consec:0, plies:0, movesLeft:null };

/* ====== 繝ｦ繝ｼ繝・ぅ繝ｪ繝・ぅ ====== */
function toCoord(x,y){ return letters[x] + String(N-y); }
function xyCenterPx(x,y){ return { left: x*CELL + CELL/2, top: y*CELL + CELL/2 }; }
function neighbors(x,y){ return [[x-1,y],[x+1,y],[x,y-1],[x,y+1]].filter(([a,b])=>a>=0&&a<N&&b>=0&&b<N); }
function getMovesLeft(){ const progressed = Math.max(0, moves.length - moveStart); return Math.max(0, moveLimit - progressed); }

/* ====== 鄂ｮ遏ｳ/蜿悶ｊ髯､縺・====== */
function flood(x,y,color,vis=new Set()){
  const key=`${x},${y}`; if(vis.has(key)) return {stones:[],libs:new Set()};
  vis.add(key);
  let stones=[[x,y]], libs=new Set();
  for(const [nx,ny] of neighbors(x,y)){
    if(board[ny][nx]===0) libs.add(`${nx},${ny}`);
    else if(board[ny][nx]===color){
      const r=flood(nx,ny,color,vis);
      stones=stones.concat(r.stones); r.libs.forEach(s=>libs.add(s));
    }
  }
  return {stones,libs};
}
function place(color,x,y){
  if(board[y][x]!==0) return false;
  const me=color==='B'?1:2, opp=color==='B'?2:1;
  board[y][x]=me;
  let captured=0;
  for(const [nx,ny] of neighbors(x,y)){
    if(board[ny][nx]===opp){
      const g=flood(nx,ny,opp,new Set());
      if(g.libs.size===0){ for(const [sx,sy] of g.stones){ board[sy][sx]=0; captured++; } }
    }
  }
  const mine=flood(x,y,me,new Set());
  if(mine.libs.size===0 && captured===0){ board[y][x]=0; return false; }
  return true;
}

/* ====== 繧ｴ繝ｼ繧ｹ繝育浹 ====== */
let ghost=null, ghostTimer=null;
function showGhost(x,y){
  ghost={x,y}; const p=xyCenterPx(x,y);
  ghostEl.style.left=p.left+'px'; ghostEl.style.top=p.top+'px';
  ghostEl.style.backgroundImage='url("./black.png")'; ghostEl.style.display='block';
  statusEl.textContent="蜷後§轤ｹ繧偵ｂ縺・ｸ蠎ｦ繧ｿ繝・・縺ｧ遒ｺ螳・;
  if(ghostTimer) clearTimeout(ghostTimer);
  ghostTimer=setTimeout(()=>{ clearGhost(); statusEl.textContent="鮟堤分縺ｧ縺吶ら捩謇九＠縺ｦ縺上□縺輔＞縲・; },2000);
}
function clearGhost(){ ghost=null; ghostEl.style.display='none'; ghostEl.style.left='-9999px'; ghostEl.style.top='-9999px'; if(ghostTimer){clearTimeout(ghostTimer);ghostTimer=null;} }

/* ====== HUD ====== */
function renderFirstEvalFromStorage(){
  try{
    const s=localStorage.getItem('firstEval'); if(!s){ firstEvalWinrate=null; return; }
    const r=JSON.parse(s); firstEvalWinrate=(r.blackWinPct??0)/100;
  }catch{ firstEvalWinrate=null; }
}
function updateStatusHud(currentBlackWin=null){
  const remaining = getMovesLeft();
  document.getElementById("eval").textContent = `谿九ｊ謇区焚: ${remaining}`;

// 蜿励￠蜿悶▲縺ｦ繧九・縺ｯ逋ｽ蜍晉紫 竊・鮟貞享邇・∈蜿崎ｻ｢
const nowBlack = (currentBlackWin == null) ? null : (1 - currentBlackWin);
const baseBlack = (firstEvalWinrate == null) ? null : (1 - firstEvalWinrate);

let text = '・域悴險育ｮ暦ｼ・;
if (nowBlack !== null) {
  text = `${(nowBlack * 100).toFixed(1)}%`;
  if (baseBlack !== null) {
    const diffPct = (nowBlack - baseBlack) * 100;
    const sign = diffPct >= 0 ? '+' : '';
    text += ` ・亥・謇区ｯ・${sign}${diffPct.toFixed(1)}%・荏;
  }
}


  setEvalFirst(`鮟貞享邇・ ${text}`);
}

/* ====== 謠冗判 ====== */
function draw(){
  boardEl.innerHTML=""; boardEl.appendChild(ghostEl);
  const last=moves[moves.length-1]||null;
  let lastX=-1,lastY=-1;
  if(last){ lastX=letters.indexOf(last[1][0]); lastY=N-parseInt(last[1].slice(1),10); }
  for(let y=0;y<N;y++) for(let x=0;x<N;x++){
    const cell=document.createElement('div'); cell.className='cell';
    const v=board[y][x];
    if(v){
      const st=document.createElement('div'); st.className='stone '+(v===1?'black':'white');
      if(x===lastX&&y===lastY) st.classList.add('lastmove'); cell.appendChild(st);
    }
    cell.addEventListener('pointerdown', async (e)=>{
      if(e&&e.pointerType&&e.pointerType!=='mouse') e.preventDefault();
      
  if (gameOver) { statusEl.textContent="邨ゆｺ・＠縺ｾ縺励◆縲ゅ檎乢繧偵け繝ｪ繧｢縲阪∪縺溘・縲御ｸｭ逶､隱ｭ縺ｿ霎ｼ縺ｿ縲阪ｒ謚ｼ縺励※縺上□縺輔＞縲・; return; }
  if(!yourTurn) return;

      if(ghost && ghost.x===x && ghost.y===y){
        clearGhost();
        if(!place('B',x,y)){ statusEl.textContent="縺昴％縺ｫ縺ｯ謇薙※縺ｾ縺帙ｓ縲・; return; }
        try{ const humanMove=toCoord(x,y); window.AiMoveNLP?.reactToHumanMove?.(humanMove); }catch{}
        moves.push(["B",toCoord(x,y)]);
        endState.plies++; endState.movesLeft=getMovesLeft();
        draw(); updateStatusHud(null);
        yourTurn=false; statusEl.textContent="AI諤晁・ｸｭ窶ｦ";
        await aiReply();
      }else{
        showGhost(x,y);
      }
    }, {passive:false});
    boardEl.appendChild(cell);
  }
}

/* ====== KataGo蠢懃ｭ・竊・譌ｩ譛溽ｵゆｺ・谿九ｊ謇区焚邨ゆｺ・蛻､螳・====== */
const REPORT_AS='PLAYER_TO_MOVE';
function readAdvantage(kmsg){
  const root=kmsg?.rootInfo||kmsg; if(!root) return {mode:null};
  const isWhiteToMove = root.currentPlayer==='W';
  if(typeof root.scoreLead==="number"){
    let lead=root.scoreLead; if(REPORT_AS==='PLAYER_TO_MOVE' && isWhiteToMove) lead=-lead;
    return {mode:"score", value:lead, abs:Math.abs(lead), leader:lead>0?'B':(lead<0?'W':null)};
  }
  if(typeof root.winrate==="number"){
    let bw = root.winrate; if(REPORT_AS==='PLAYER_TO_MOVE' && isWhiteToMove) bw=1-bw;
    const val=bw-0.5;
    return {mode:"winrate", value:val, abs:Math.abs(val), leader:val>0?'B':(val<0?'W':null)};
  }
  return {mode:null};
}
function checkEarlyEnd(kmsg){
  const a=readAdvantage(kmsg); if(!a.mode) return false;
  if(endState.plies < END_RULE.early.minPlies) return false;
  let over=false;
  if(a.mode==="score") over = a.abs >= END_RULE.early.scoreLeadAbs;
  else over = a.abs >= END_RULE.early.winrateEdge;
  if(over){ endState.consec++; if(endState.consec>=END_RULE.early.requireConsec){ return {winner:a.leader, reason:a.mode==="score"?"scoreLead":"winrate", value:a.value}; } }
  else endState.consec=0;
  return false;
}
function checkDepleted(kmsg){
  if(END_RULE.onDepleted!=="advantage") return false;
  if(getMovesLeft()!==0) return false;
  const a=readAdvantage(kmsg); if(!a.mode||!a.leader) return {winner:null, reason:"draw_or_unknown"};
  return {winner:a.leader, reason:a.mode==="score"?"scoreLead":"winrate", value:a.value};
}
function finishGame(verdict){
  const who = verdict.winner==='B'?"鮟・:(verdict.winner==='W'?"逋ｽ":"・井ｸ肴・・・);
  const label = verdict.reason==='scoreLead'
    ? `轤ｹ蟾ｮ ${verdict.value?.toFixed?.(1)}`
    : verdict.reason==='winrate'
    ? `蜍晉紫蟾ｮ ${(Math.abs((verdict.value||0))*100).toFixed(1)}%` : "鮟貞享邇・ｸ肴・";
  statusEl.textContent=`邨ゆｺ・ ${who} 縺ｮ蜍昴■・・{label}・荏;

  // 逶､髱｢縺縺醍┌蜉ｹ蛹悶ゅ・繧ｿ繝ｳ縺ｯ菴ｿ縺医ｋ・医御ｸｭ逶､隱ｭ縺ｿ霎ｼ縺ｿ縲阪檎乢繧偵け繝ｪ繧｢縲阪↑縺ｩ・・
  setBoardInteractive(false);
  sprintBtn.disabled = false;
  resetBtn.disabled  = false;


(el=>el.disabled=true);
}

/* ====== AI蠢懃ｭ・====== */
async function aiReply(){
  try{
    const diff = document.getElementById('difficulty').value || 'normal';
    const visits = diff === "easy" ? 2 : diff === "hard" ? 128 : 64;

    // 1) 驕ｸ謚槭お繝ｳ繧ｸ繝ｳ縺ｧ逹謇九ｒ險育ｮ・
    const analyzePayload = { rules:"japanese", komi:6.5, boardXSize:N, boardYSize:N, maxVisits:visits, moves };
    const aResp = await fetch(`/api/analyze?engine=${encodeURIComponent(diff)}`, {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({...analyzePayload, maxVisits: (selEngine==="easy"?4:8)})
    });
    const aData = await aResp.json();
    if (DEBUG) { lastEl.style.display='block'; lastEl.textContent = JSON.stringify(aData.katago,null,2); }

    // 2) 蛻､螳壹・ hard 蝗ｺ螳壹〒蜿門ｾ・
    const evalPayload = { rules:"japanese", komi:6.5, boardXSize:N, boardYSize:N, maxVisits:128, moves };
    const eResp = await fetch(`/api/eval`, {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({...evalPayload, maxVisits: 8})
    });
    const eData = await eResp.json();

    // 陦ｨ遉ｺ逕ｨ・・ard 縺ｮ繝｢繝・Ν蜷阪ｒ蜃ｺ縺呻ｼ・
    const judgeModel = eData?.modelName || "unknown";
    if (statusEl) statusEl.textContent = `蛻､螳・ hard / ${judgeModel}・・I諤晁・ｸｭ窶ｦ・荏;

    // 鮟貞享邇・ｒ鮟呈焔逡ｪ隕也せ縺ｧ
    let blackWin = null;
    if (typeof eData?.winrateBlack === "number") blackWin = eData.winrateBlack;

    // 蛻晄焔隧穂ｾ｡縺ｮ菫晏ｭ假ｼ医≠縺ｪ縺溘・譛蛻昴・鮟呈焔・・
    if (blackWin !== null) {
      const blackCount = moves.filter(([bw])=>bw==="B").length;
      const isUsersFirstBlack = blackCount === blackBaseline + 1;
      if (isUsersFirstBlack && !localStorage.getItem('firstEval')){
        const lastBlack = [...moves].reverse().find(m=>m[0]==="B")?.[1] ?? null;
        const rec={
          ts:Date.now(), move:lastBlack,
          blackWinPct:blackWin*100, whiteWinPct:(1-blackWin)*100,
          scoreLead: (typeof eData?.scoreLead==="number" ? eData.scoreLead : null)
        };
        localStorage.setItem('firstEval', JSON.stringify(rec));
        renderFirstEvalFromStorage();
        firstEvalWinrate = blackWin;
      }
    }

    updateStatusHud(blackWin);

    // 譌ｩ譛溽ｵゆｺ・貅莠・愛螳壹・ hard 隧穂ｾ｡縺ｧ
    const kmsg = eData?.katago || null;
    const early = kmsg && checkEarlyEnd(kmsg);
    if (early){ finishGame(early); return; }
    const dep = kmsg && checkDepleted(kmsg);
    if (dep){ finishGame(dep); return; }

    // 3) 螳滄圀縺ｮ逹謇九・ analyze 縺ｮ譛蝟・焔
    const mv = aData.bestMove;
    if(!mv){ statusEl.textContent="AI縺ｮ謇九′蠕励ｉ繧後∪縺帙ｓ縺ｧ縺励◆縲・; yourTurn=true; return; }
    const x=letters.indexOf(mv[0]); const y=N-parseInt(mv.slice(1),10);
    if(x<0||y<0||x>=N||y>=N){ statusEl.textContent=`荳肴ｭ｣縺ｪ謇・ ${mv}`; yourTurn=true; return; }
    if(!place('W',x,y)){ statusEl.textContent=`AI謇・${mv})縺檎ｽｮ縺代∪縺帙ｓ縲Ａ; yourTurn=true; draw(); return; }
    moves.push(["W",mv]);
    endState.plies++; endState.movesLeft=getMovesLeft();
    draw(); updateStatusHud(blackWin);

    try{ window.AiMoveNLP?.describe?.({bestMove:mv, katago:aData.katago, moves}); }catch{}
    statusEl.textContent="鮟堤分縺ｧ縺吶・; yourTurn=true;
  }catch(e){
    statusEl.textContent="騾壻ｿ｡繧ｨ繝ｩ繝ｼ: "+e; yourTurn=true;
  }
}
/* ====== 繝ｩ繝ｳ繝繝蛻晄悄螻髱｢縺ｮ驕ｩ逕ｨ ====== */
function applyMoves(mvList){
  clearGhost();
  board = Array.from({length:N},()=>Array(N).fill(0));
  moves=[]; yourTurn=true;
  for(const [bw,coord] of mvList){
    const x=letters.indexOf(coord[0]); const y=N-parseInt(coord.slice(1),10);
    if(x<0||y<0||x>=N||y>=N) continue;
    place(bw,x,y); moves.push([bw,coord]);
  }
  draw();
  const blackToMove=(moves.length%2===0);
  yourTurn=blackToMove;
  statusEl.textContent = blackToMove ? "鮟堤分縺ｧ縺呻ｼ医Λ繝ｳ繝繝蛻晄悄逶､髱｢・峨・ : "逋ｽ逡ｪ縺ｧ縺吶・I縺ｮ逹謇九ｒ蠕・▲縺ｦ縺・∪縺吮ｦ";
  if(!blackToMove) aiReply();

  blackBaseline = moves.filter(([bw])=>bw==="B").length;
  localStorage.removeItem('firstEval'); renderFirstEvalFromStorage(); firstEvalWinrate=null;

  moveStart = moves.length; // 竊舌％縺薙ｒ蝓ｺ貅悶→縺吶ｋ
  updateStatusHud(null);
}

/* ====== UI繧､繝吶Φ繝・====== */
sprintBtn.addEventListener("click", async ()=>{
  statusEl.textContent="蛻晄悄螻髱｢繧貞叙蠕嶺ｸｭ窶ｦ";
  const resp=await fetch("/api/sprint/random"); const data=await resp.json();
  if(!data.ok){ statusEl.textContent="蛻晄悄螻髱｢蜿門ｾ怜､ｱ謨・ "+(data.error||""); return; }
  applyMoves(data.moves||[]);
  if(DEBUG){ lastEl.style.display='block'; lastEl.textContent="Loaded recId: "+(data.recId??"(unknown)")+"\n"+JSON.stringify({moves:data.moves},null,2); }
  moveLimit=20; updateStatusHud(null);
});
resetBtn.addEventListener('click', ()=>{
setBoardInteractive(true);
  firstEvalWinrate=null; updateStatusHud(null); clearGhost();
  board=Array.from({length:N},()=>Array(N).fill(0)); moves=[]; yourTurn=true; moveStart=moves.length;
  lastEl.textContent=""; statusEl.textContent="鮟堤分縺ｧ縺吶ら捩謇九＠縺ｦ縺上□縺輔＞縲・;
  blackBaseline=0; localStorage.removeItem('firstEval'); renderFirstEvalFromStorage(); draw();
});

/* ====== 蛻晄悄蛹・====== */
localStorage.removeItem('firstEval'); renderFirstEvalFromStorage(); updateStatusHud(null); draw();
</script>
<script src="./aiComment.js"></script>
</body>
</html>
